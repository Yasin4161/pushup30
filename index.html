<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çiftlik İmparatorluğu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Baloo 2', cursive; touch-action: manipulation; overflow: hidden; }
        .game-container { width: 100%; max-width: 95vw; max-height: 95vh; }
        canvas { background-color: #78c078; border-radius: 1rem; border: 6px solid #8B5A2B; width: 100%; height: auto; aspect-ratio: 20 / 15; box-shadow: inset 0 0 20px rgba(0,0,0,0.2); }
        .control-button, .action-button { width: 60px; height: 60px; border-radius: 50%; background-color: #fbbf24; border: 2px solid #f59e0b; box-shadow: 0 5px 10px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; user-select: none; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; }
        .control-button:active, .action-button:active { transform: translateY(2px) scale(0.95); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center h-screen">

    <!-- BAŞLANGIÇ EKRANI -->
    <div id="start-screen" class="w-full h-full flex flex-col items-center justify-center text-white text-center p-4 bg-cover bg-center" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://placehold.co/1200x800/22c55e/78c078?text=+)');">
        <h1 class="text-4xl md:text-7xl font-bold mb-8 text-yellow-300 drop-shadow-lg" style="text-shadow: 3px 3px 0 #000;">Çiftlik İmparatorluğu</h1>
        <button id="play-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-lg text-2xl border-b-4 border-green-700 hover:border-green-600 shadow-lg transform hover:scale-105 transition-transform animate-pulse">
            Oyna
        </button>
    </div>

    <!-- OYUN EKRANI -->
    <div id="game-container" class="game-container bg-gray-800 text-white rounded-2xl shadow-2xl p-4 flex-col gap-2 hidden">
        <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center bg-gray-700/80 p-2 rounded-lg text-sm md:text-base">
            <div>💰 <span id="money">0</span></div>
            <div>🥛 <span id="milk">0</span></div>
            <div>🥚 <span id="egg">0</span></div>
            <div>🪵 <span id="wood">0</span></div>
            <div>🌾 <span id="wheat">0</span></div>
            <div>🥡 <span id="flour">0</span></div>
        </div>
        <div id="message-box" class="h-10 bg-black/30 rounded-lg flex items-center justify-center p-2 text-center text-yellow-200 font-semibold"></div>
        <div class="flex-grow flex items-center justify-center"><canvas id="game-canvas"></canvas></div>
        <div class="flex flex-col sm:flex-row items-center justify-between gap-2">
            <div class="grid grid-cols-3 gap-2 w-48">
                <div></div> <button id="up-btn" class="control-button">⬆️</button> <div></div>
                <button id="left-btn" class="control-button">⬅️</button>
                <button id="down-btn" class="control-button">⬇️</button>
                <button id="right-btn" class="control-button">➡️</button>
            </div>
            <div class="flex items-center gap-4">
                 <button id="hire-helper-btn" class="action-button bg-blue-500 hover:bg-blue-600" title="Yardımcı Kirala">🧑‍🔧</button>
                 <button id="market-btn" class="action-button bg-green-500 hover:bg-green-600" title="Pazar">🛒</button>
            </div>
        </div>
    </div>

    <!-- MODALLAR -->
    <div id="modal-backdrop" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 invisible opacity-0">
        <div id="modal-content" class="bg-slate-800 border border-slate-600 rounded-lg p-6 max-w-sm w-full text-white shadow-xl">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-yellow-300"></h2>
            <div id="modal-body" class="space-y-3 max-h-96 overflow-y-auto"></div>
            <button id="modal-close-btn" class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Kapat</button>
        </div>
    </div>
    
    <script>
    // --- OYUNU BAŞLATMA ---
    document.getElementById('play-btn').addEventListener('click', () => {
        document.getElementById('start-screen').classList.add('hidden');
        const gameContainer = document.getElementById('game-container');
        gameContainer.classList.remove('hidden');
        gameContainer.classList.add('flex');
        try {
            init();
        } catch(e) {
            console.error("Initialization Error:", e);
            const messageBox = document.getElementById('message-box');
            if (messageBox) { messageBox.style.color = 'red'; messageBox.textContent = 'OYUN BAŞLATMA HATASI: ' + e.message; }
        }
    });

    // --- GLOBAL DEĞİŞKENLER ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const BOARD_WIDTH = 20, BOARD_HEIGHT = 15, TILE_SIZE = 50;
    canvas.width = BOARD_WIDTH * TILE_SIZE;
    canvas.height = BOARD_HEIGHT * TILE_SIZE;

    const moneyEl = document.getElementById('money');
    const milkEl = document.getElementById('milk');
    const eggEl = document.getElementById('egg');
    const woodEl = document.getElementById('wood');
    const wheatEl = document.getElementById('wheat');
    const flourEl = document.getElementById('flour');
    const messageBox = document.getElementById('message-box');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    
    let gameState = {};
    let sounds = {};
    let audioStarted = false;
    const keys = { up: { pressed: false }, down: { pressed: false }, left: { pressed: false }, right: { pressed: false } };

    const COOLDOWNS = { milk: 10 * 60, egg: 7 * 60, wheat: 12 * 60, wood: 30 * 60 };
    const PROCESS_TIMES = { flour: 5 * 60, bread: 8 * 60 };
    const ITEM_PRICES = { milk: 10, egg: 5, wood: 8, wheat: 4, flour: 12, bread: 30 };
    const COSTS = {
        helpers: { milk: 100, egg: 150, wood: 250, miller: 400, baker: 500, collector: 350, seller: 700 },
        upgrades: { cow: 200, chicken: 150, wheat: 100, oven: 300 },
        buildings: { marketStall: 1000, mill: 800 }
    };
    const ITEM_EMOJIS = { milk: '🥛', egg: '🥚', wood: '🪵', wheat: '🌾', flour: '🥡', bread: '🍞' };
    const toPixels = (gridPos) => ({ x: gridPos.x * TILE_SIZE + TILE_SIZE / 2, y: gridPos.y * TILE_SIZE + TILE_SIZE / 2 });

    // --- SES FONKSİYONLARI ---
    function initializeSounds() { if (typeof Tone === 'undefined') { console.error("Tone.js kütüphanesi yüklenemedi."); return; } sounds = { synth: new Tone.Synth().toDestination(), collect: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.1 } }).toDestination(), sale: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(), error: new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination(), background: new Tone.MembraneSynth().toDestination() }; }
    function playSound(type, note, duration = '8n') { if (!audioStarted || !sounds[type]) return; try { sounds[type].triggerAttackRelease(note, duration); } catch (e) { console.error("Ses çalınamadı:", e); } }

    // --- ÇİZİM FONKSİYONLARI ---
    function drawWithShadow(drawFunc) { ctx.shadowColor = 'rgba(0, 0, 0, 0.2)'; ctx.shadowBlur = 8; ctx.shadowOffsetX = 4; ctx.shadowOffsetY = 4; drawFunc(); ctx.shadowColor = 'transparent'; ctx.shadowBlur = 0; ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0; }
    function drawPlayer(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = '#ffc0cb'; ctx.beginPath(); ctx.arc(pos.x, pos.y - 10, 12, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = '#8B4513'; ctx.fillRect(pos.x - 15, pos.y - 22, 30, 8); ctx.fillRect(pos.x - 8, pos.y - 30, 16, 10); ctx.fillStyle = '#4682B4'; ctx.beginPath(); ctx.moveTo(pos.x - 10, pos.y); ctx.lineTo(pos.x + 10, pos.y); ctx.lineTo(pos.x + 15, pos.y + 25); ctx.lineTo(pos.x - 15, pos.y + 25); ctx.closePath(); ctx.fill(); }); }
    function drawCow(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = 'white'; ctx.beginPath(); ctx.ellipse(pos.x, pos.y, 30, 20, 0, 0, Math.PI * 2); ctx.fill(); ctx.strokeStyle = 'black'; ctx.lineWidth = 2; ctx.stroke(); ctx.fillStyle = 'black'; ctx.beginPath(); ctx.ellipse(pos.x - 15, pos.y - 5, 8, 5, -0.5, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.ellipse(pos.x + 10, pos.y + 8, 10, 6, 0.7, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(pos.x + 25, pos.y - 10, 15, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(pos.x + 30, pos.y - 12, 2, 0, Math.PI * 2); ctx.fill(); }); }
    function drawChicken(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = '#FFFACD'; ctx.beginPath(); ctx.arc(pos.x, pos.y, 15, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(pos.x + 10, pos.y - 12, 8, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = 'red'; ctx.beginPath(); ctx.moveTo(pos.x + 8, pos.y - 20); ctx.lineTo(pos.x + 12, pos.y - 23); ctx.lineTo(pos.x + 14, pos.y - 20); ctx.fill(); ctx.fillStyle = 'orange'; ctx.beginPath(); ctx.moveTo(pos.x + 18, pos.y - 12); ctx.lineTo(pos.x + 22, pos.y - 10); ctx.lineTo(pos.x + 18, pos.y - 8); ctx.fill(); }); }
    function drawWheatField(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = '#f5deb3'; for(let i = -20; i < 25; i += 15) { for (let j = -20; j < 25; j += 15) { ctx.fillRect(pos.x + i, pos.y + j, 5, 15); } } }); }
    function drawTree(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = '#8B4513'; ctx.fillRect(pos.x - 5, pos.y - 20, 10, 40); ctx.fillStyle = '#228B22'; ctx.beginPath(); ctx.arc(pos.x, pos.y - 30, 25, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = '#3CB371'; ctx.beginPath(); ctx.arc(pos.x + 10, pos.y - 40, 20, 0, Math.PI * 2); ctx.fill(); }); }
    function drawMill(ctx, pos, angle) { drawWithShadow(() => { ctx.fillStyle = '#D2B48C'; ctx.beginPath(); ctx.moveTo(pos.x - 20, pos.y + 30); ctx.lineTo(pos.x - 25, pos.y - 20); ctx.lineTo(pos.x + 25, pos.y - 20); ctx.lineTo(pos.x + 20, pos.y + 30); ctx.closePath(); ctx.fill(); ctx.fillStyle = '#A0522D'; ctx.beginPath(); ctx.arc(pos.x, pos.y - 20, 25, 0, Math.PI, true); ctx.fill(); ctx.save(); ctx.translate(pos.x, pos.y - 15); ctx.rotate(angle); ctx.fillStyle = '#8B4513'; ctx.fillRect(-5, -40, 10, 80); ctx.fillRect(-40, -5, 80, 10); ctx.restore(); }); }
    function drawOven(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = '#A9A9A9'; ctx.fillRect(pos.x - 25, pos.y - 20, 50, 40); ctx.fillStyle = '#8B4513'; ctx.fillRect(pos.x - 28, pos.y - 23, 56, 5); ctx.fillStyle = 'black'; ctx.fillRect(pos.x - 15, pos.y, 30, 15); }); }
    function drawSalesCounter(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = '#D2B48C'; ctx.fillRect(pos.x - 30, pos.y - 10, 60, 20); ctx.fillStyle = '#DC143C'; ctx.beginPath(); ctx.moveTo(pos.x - 35, pos.y - 25); ctx.lineTo(pos.x + 35, pos.y - 25); ctx.lineTo(pos.x + 30, pos.y - 10); ctx.lineTo(pos.x - 30, pos.y - 10); ctx.closePath(); ctx.fill(); }); }
    function drawStorageBox(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = '#8B4513'; ctx.fillRect(pos.x - 20, pos.y - 15, 40, 30); ctx.strokeStyle = '#5a2d0c'; ctx.lineWidth = 3; ctx.strokeRect(pos.x - 20, pos.y - 15, 40, 30); ctx.beginPath(); ctx.moveTo(pos.x - 20, pos.y - 15); ctx.lineTo(pos.x + 20, pos.y + 15); ctx.stroke(); }); }
    function drawCustomer(ctx, pos) { drawWithShadow(() => { ctx.fillStyle = '#e0ac69'; ctx.beginPath(); ctx.arc(pos.x, pos.y - 10, 12, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = '#800080'; ctx.fillRect(pos.x - 10, pos.y, 20, 25); }); }
    function drawHelper(ctx, pos, type, hasItem) { drawWithShadow(() => { const colors = {milk: '#00FFFF', egg: '#fde047', wood: '#a3e635', miller: '#facc15', baker: '#fb923c', collector: '#fca5a5', seller: '#90EE90'}; ctx.fillStyle = '#C0C0C0'; ctx.beginPath(); ctx.arc(pos.x, pos.y - 10, 10, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = colors[type] || '#A9A9A9'; ctx.beginPath(); ctx.arc(pos.x, pos.y - 10, 4, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = '#A9A9A9'; ctx.fillRect(pos.x - 8, pos.y, 16, 20); if(hasItem) { ctx.font = '18px sans-serif'; const itemEmoji = {milk: '🥛', egg: '🥚', wood: '🪵', miller: '🌾', baker: '🥡', collector: '🍞'}[type] || '❔'; ctx.fillText(itemEmoji, pos.x + 15, pos.y); } }); }
    function drawIndicator(ctx, pos, emoji) { ctx.font = '24px sans-serif'; ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'; ctx.beginPath(); ctx.arc(pos.x, pos.y - 45, 18, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = 'black'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(emoji, pos.x, pos.y - 45); }
    function drawLevelIndicator(ctx, pos, level) { if (level <= 1) return; ctx.fillStyle = 'rgba(251, 191, 36, 0.9)'; ctx.beginPath(); ctx.arc(pos.x + 25, pos.y - 25, 12, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = 'black'; ctx.font = 'bold 14px Baloo 2'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(`x${level}`, pos.x + 25, pos.y - 25); }
    function drawOrderBubble(ctx, pos, emoji) { const bubbleX = pos.x; const bubbleY = pos.y - 50; ctx.fillStyle = 'white'; ctx.strokeStyle = 'black'; ctx.lineWidth = 2; ctx.beginPath(); ctx.roundRect(bubbleX - 20, bubbleY - 20, 40, 40, 10); ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.moveTo(bubbleX, bubbleY + 20); ctx.lineTo(bubbleX - 5, bubbleY + 25); ctx.lineTo(bubbleX + 5, bubbleY + 25); ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.font = '28px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = 'black'; ctx.fillText(emoji, bubbleX, bubbleY); }
    function drawBackground(ctx) { ctx.fillStyle = '#78c078'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = '#D2B48C'; ctx.beginPath(); ctx.ellipse(canvas.width / 2, canvas.height, canvas.width * 0.9, canvas.height * 0.5, 0, 0, Math.PI * 2); ctx.fill(); }

    // --- RENDER ---
    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBackground(ctx);
        
        let objectsToDraw = [
            ...Object.values(gameState.locations).filter(loc => loc.owned).map(loc => {
                switch(loc.type) {
                    case 'salesCounter': return { draw: drawSalesCounter, obj: loc };
                    case 'storageBox': return { draw: drawStorageBox, obj: loc };
                    case 'cow': return { draw: drawCow, obj: loc, indicator: '🥛' };
                    case 'chicken': return { draw: drawChicken, obj: loc, indicator: '🥚' };
                    case 'wheat': return { draw: drawWheatField, obj: loc, indicator: '🌾' };
                    case 'oven': return { draw: drawOven, obj: loc };
                    case 'tree': return { draw: drawTree, obj: loc, indicator: '🪵' };
                    case 'mill': return { draw: drawMill, obj: loc, angle: gameState.millAngle };
                }
            }).filter(Boolean),
            ...gameState.helpers.map(h => ({ draw: drawHelper, obj: h })),
            { draw: drawPlayer, obj: gameState.player },
            ...(gameState.customer1 ? [{ draw: drawCustomer, obj: gameState.customer1 }] : []),
            ...(gameState.customer2 ? [{ draw: drawCustomer, obj: gameState.customer2 }] : [])
        ];
        
        objectsToDraw.sort((a, b) => (a.obj.pos.y) - (b.obj.pos.y));
        objectsToDraw.forEach(({ draw, obj, indicator, angle }) => {
            const pos = obj.pos;
            if (!pos) return;
            if (angle !== undefined) { draw(ctx, pos, angle); }
            else { draw(ctx, pos, obj.type, obj.hasItem); }
            if (indicator && obj.ready) drawIndicator(ctx, pos, indicator);
            if (obj.level > 1) drawLevelIndicator(ctx, pos, obj.level);
        });

        if (gameState.customer1) drawOrderBubble(ctx, gameState.customer1.pos, ITEM_EMOJIS[gameState.customer1.wants]);
        if (gameState.customer2) drawOrderBubble(ctx, gameState.customer2.pos, ITEM_EMOJIS[gameState.customer2.wants]);

        const oven = gameState.locations.oven;
        if (oven.hasProduct) { ctx.font = '30px sans-serif'; ctx.fillText('🍞', oven.pos.x, oven.pos.y); }
        else if (oven.processing) { ctx.font = '30px sans-serif'; ctx.fillText('♨️', oven.pos.x, oven.pos.y); }

        const mill = gameState.locations.mill;
        if (mill.owned && mill.hasProduct) { ctx.font = '30px sans-serif'; ctx.fillText('🥡', mill.pos.x, mill.pos.y); }
        else if (mill.owned && mill.processing) { ctx.font = '30px sans-serif'; ctx.fillText('⚙️', mill.pos.x, mill.pos.y); }

        moneyEl.textContent = gameState.player.money;
        milkEl.textContent = `${gameState.storage.milk}`;
        eggEl.textContent = `${gameState.storage.egg}`;
        woodEl.textContent = `${gameState.storage.wood}`;
        wheatEl.textContent = `${gameState.storage.wheat}`;
        flourEl.textContent = `${gameState.storage.flour}`;
    }

    // --- UPDATE & OYUN MANTIĞI ---
    function update() {
        if (keys.up.pressed && gameState.player.pos.y > 0) gameState.player.pos.y -= 4;
        if (keys.down.pressed && gameState.player.pos.y < canvas.height) gameState.player.pos.y += 4;
        if (keys.left.pressed && gameState.player.pos.x > 0) gameState.player.pos.x -= 4;
        if (keys.right.pressed && gameState.player.pos.x < canvas.width) gameState.player.pos.x += 4;
        
        checkInteraction();
        
        Object.values(gameState.locations).forEach(loc => { if(loc.owned && loc.cooldown > 0) { loc.cooldown--; if(loc.cooldown <= 0) loc.ready = true; }});
        gameState.millAngle += 0.01;
        
        const spawnCustomer = (customerKey, stallPos) => {
            if (!gameState[customerKey] && Math.random() < 0.005) {
                let possibleWants = ['milk', 'egg', 'wood', 'wheat'];
                if (gameState.locations.mill.owned) { possibleWants.push('flour', 'bread'); }
                const randomWant = possibleWants[Math.floor(Math.random() * possibleWants.length)];
                gameState[customerKey] = { pos: {x: stallPos.x, y: stallPos.y + TILE_SIZE}, wants: randomWant, patience: 120 * 60 };
            }
            if (gameState[customerKey] && --gameState[customerKey].patience <= 0) { gameState[customerKey] = null; showMessage("Müşteri gitti!", 'error'); playSound('error', 'C3'); }
        };
        spawnCustomer('customer1', gameState.locations.salesCounter1.pos);
        if (gameState.locations.salesCounter2.owned) {
            spawnCustomer('customer2', gameState.locations.salesCounter2.pos);
        }
        
        Object.values(gameState.locations).filter(loc => loc.owned && loc.processing).forEach(loc => {
             if (--loc.timer <= 0) {
                loc.processing = false;
                loc.hasProduct = true;
                const product = loc.type === 'oven' ? 'Ekmek' : 'Un';
                showMessage(`${product} hazır!`, 'success');
                playSound('collect', 'G5');
             }
        });
        
        gameState.helpers.forEach(updateHelper);
    }

    // --- YARDIMCI YAPAY ZEKASI (YENİDEN YAZILDI) ---
    function moveTowards(entity, targetPos) {
        const speed = 2.5;
        const dist = Math.hypot(targetPos.x - entity.pos.x, targetPos.y - entity.pos.y);
        if (dist < speed) {
            entity.pos.x = targetPos.x;
            entity.pos.y = targetPos.y;
            return true;
        }
        const angle = Math.atan2(targetPos.y - entity.pos.y, targetPos.x - entity.pos.y);
        entity.pos.x += Math.cos(angle) * speed;
        entity.pos.y += Math.sin(angle) * speed;
        return false;
    }

    function updateHelper(h) {
        if (h.state === 'idle') {
            findTaskFor(h);
        } else if (h.state === 'moving') {
            if (!h.targetPos) { // Güvenlik kontrolü
                h.state = 'idle';
                return;
            }
            if (moveTowards(h, h.targetPos)) {
                executeTask(h);
            }
        }
    }

    function findTaskFor(h) {
        const storagePos = gameState.locations.storageBox.pos;
        // Görevleri öncelik sırasına göre ara
        if (h.type === 'seller') {
            const customer = gameState.customer1 && gameState.storage[gameState.customer1.wants] > 0 ? gameState.customer1 : (gameState.customer2 && gameState.storage[gameState.customer2.wants] > 0 ? gameState.customer2 : null);
            if (customer) {
                h.state = 'moving'; h.task = 'fetch_for_sale'; h.targetPos = storagePos; h.payload = { item: customer.wants, customer };
                return;
            }
        }
        if (h.type === 'collector') {
            const productSource = Object.values(gameState.locations).find(l => l.owned && l.hasProduct && !l.claimedBy);
            if (productSource) {
                h.state = 'moving'; h.task = 'collect_product'; h.targetPos = productSource.pos; h.payload = { source: productSource };
                productSource.claimedBy = h.id;
                return;
            }
        }
        if (h.type === 'baker') {
            const oven = gameState.locations.oven;
            if (oven.owned && !oven.processing && !oven.hasProduct && gameState.storage.flour >= oven.level) {
                h.state = 'moving'; h.task = 'fetch_for_baking'; h.targetPos = storagePos; h.payload = { machine: oven };
                return;
            }
        }
        if (h.type === 'miller') {
            const mill = gameState.locations.mill;
            if (mill.owned && !mill.processing && !mill.hasProduct && gameState.storage.wheat >= mill.level) {
                h.state = 'moving'; h.task = 'fetch_for_milling'; h.targetPos = storagePos; h.payload = { machine: mill };
                return;
            }
        }
        const basicCollectorMap = { milk: 'cow', egg: 'chicken', wood: 'tree' };
        if (basicCollectorMap[h.type]) {
            const source = Object.values(gameState.locations).find(l => l.type === basicCollectorMap[h.type] && l.owned && l.ready && !l.claimedBy);
            if (source) {
                h.state = 'moving'; h.task = 'collect_raw'; h.targetPos = source.pos; h.payload = { source, item: h.type };
                source.claimedBy = h.id;
                return;
            }
        }
    }

    function executeTask(h) {
        const storagePos = gameState.locations.storageBox.pos;
        switch (h.task) {
            case 'collect_raw':
                h.payload.source.ready = false;
                h.payload.source.cooldown = COOLDOWNS[h.payload.item];
                h.payload.source.claimedBy = null;
                h.hasItem = true;
                h.state = 'moving';
                h.task = 'deliver_to_storage';
                h.targetPos = storagePos;
                break;
            case 'deliver_to_storage':
                gameState.storage[h.payload.item] += h.payload.source.level;
                h.hasItem = false;
                h.state = 'idle';
                h.task = null;
                h.payload = null;
                break;
            case 'fetch_for_milling':
            case 'fetch_for_baking':
                gameState.storage[h.task === 'fetch_for_milling' ? 'wheat' : 'flour'] -= h.payload.machine.level;
                h.hasItem = true;
                h.state = 'moving';
                h.task = h.task === 'fetch_for_milling' ? 'deliver_to_mill' : 'deliver_to_oven';
                h.targetPos = h.payload.machine.pos;
                break;
            case 'deliver_to_mill':
            case 'deliver_to_oven':
                h.hasItem = false;
                h.payload.machine.processing = true;
                h.payload.machine.timer = h.task === 'deliver_to_mill' ? PROCESS_TIMES.flour : PROCESS_TIMES.bread;
                h.state = 'idle';
                h.task = null;
                h.payload = null;
                break;
            case 'collect_product':
                h.payload.source.hasProduct = false;
                h.payload.source.claimedBy = null;
                h.hasItem = true;
                h.state = 'moving';
                h.task = 'deliver_product_to_storage';
                h.targetPos = storagePos;
                break;
            case 'deliver_product_to_storage':
                const product = h.payload.source.type === 'oven' ? 'bread' : 'flour';
                gameState.storage[product] += h.payload.source.level;
                h.hasItem = false;
                h.state = 'idle';
                h.task = null;
                h.payload = null;
                break;
            case 'fetch_for_sale':
                h.hasItem = true;
                h.state = 'moving';
                h.task = 'deliver_to_customer';
                h.targetPos = h.payload.customer.pos;
                break;
            case 'deliver_to_customer':
                h.hasItem = false;
                gameState.player.money += ITEM_PRICES[h.payload.item];
                showMessage('Satış yapıldı!', 'success');
                playSound('sale', 'C5');
                if (h.payload.customer === gameState.customer1) gameState.customer1 = null;
                else gameState.customer2 = null;
                h.state = 'idle';
                h.task = null;
                h.payload = null;
                break;
        }
    }

    function checkInteraction() {
        const now = Date.now(); if (now - gameState.lastInteractionTime < 300) return; let interacted = false;
        Object.values(gameState.locations).forEach(loc => { if(loc.owned && Math.hypot(gameState.player.pos.x - loc.pos.x, gameState.player.pos.y - loc.pos.y) < 50) {
            let itemType;
            if (loc.ready) {
                switch(loc.type) {
                    case 'cow': itemType = 'milk'; break; case 'chicken': itemType = 'egg'; break;
                    case 'wheat': itemType = 'wheat'; break; case 'tree': itemType = 'wood'; break;
                }
                if (itemType) { gameState.storage[itemType] += loc.level; loc.ready = false; loc.cooldown = COOLDOWNS[itemType]; showMessage(`${loc.level} ${itemType} topladın!`, 'success'); playSound('collect', 'E5'); interacted = true; }
            }
            if (loc.type === 'oven' || loc.type === 'mill') {
                if (loc.hasProduct) { const product = loc.type === 'oven' ? 'bread' : 'flour'; gameState.storage[product] += loc.level; loc.hasProduct = false; showMessage(`${loc.level} ${product} depoya koydun!`, 'success'); playSound('collect', 'G5'); interacted = true; }
                else if (!loc.processing) { const input = loc.type === 'oven' ? 'flour' : 'wheat'; if (gameState.storage[input] >= loc.level) { gameState.storage[input] -= loc.level; loc.processing = true; const output = loc.type === 'oven' ? 'bread' : 'flour'; loc.timer = PROCESS_TIMES[output]; showMessage(`${input} işleniyor...`, 'info'); interacted = true; } }
            }
        }});
        const customer = gameState.customer1 || gameState.customer2;
        if (customer && Math.hypot(gameState.player.pos.x - customer.pos.x, gameState.player.pos.y - customer.pos.y) < 50) {
            const wants = customer.wants;
            if (gameState.storage[wants] > 0) { gameState.storage[wants]--; gameState.player.money += ITEM_PRICES[wants]; showMessage('Satış yapıldı!', 'success'); playSound('sale', 'C5'); if(customer === gameState.customer1) gameState.customer1 = null; else gameState.customer2 = null; interacted = true; }
            else { showMessage('Depoda ürün yok!', 'error'); playSound('error', 'C3'); interacted = true; }
        }
        if(interacted) gameState.lastInteractionTime = now;
    }
    
    // --- MODAL & UI ---
    function openModal(title, content) { modalTitle.textContent = title; modalBody.innerHTML = content; modalBackdrop.classList.remove('invisible', 'opacity-0'); playSound('synth', 'C4'); }
    function setupModals() {
        document.getElementById('hire-helper-btn').addEventListener('click', () => {
            const content = `
                <button class="w-full bg-blue-600 p-2 rounded" onclick="hireHelper('milk')">Sütçü (${COSTS.helpers.milk}💰) 🥛</button>
                <button class="w-full bg-yellow-400 text-black p-2 rounded" onclick="hireHelper('egg')">Yumurtacı (${COSTS.helpers.egg}💰) 🥚</button>
                <button class="w-full bg-lime-600 p-2 rounded" onclick="hireHelper('wood')">Oduncu (${COSTS.helpers.wood}💰) 🪵</button>
                <button class="w-full bg-amber-500 p-2 rounded" onclick="hireHelper('miller')">Değirmenci (${COSTS.helpers.miller}💰) 🌾</button>
                <button class="w-full bg-orange-500 p-2 rounded" onclick="hireHelper('baker')">Fırıncı (${COSTS.helpers.baker}💰) 🥡</button>
                <button class="w-full bg-rose-400 p-2 rounded" onclick="hireHelper('collector')">Toplayıcı (${COSTS.helpers.collector}💰) 🍞</button>
                <button class="w-full bg-emerald-500 p-2 rounded" onclick="hireHelper('seller')">Satıcı (${COSTS.helpers.seller}💰) 🤑</button>
            `;
            openModal('Yardımcı Kirala', content);
        });
        document.getElementById('market-btn').addEventListener('click', () => {
            let content = '';
            const upgradables = { cow: 'İnek Ahırı', chicken: 'Kümes', wheat: 'Tarla', oven: 'Fırın' };
            for (const key in upgradables) {
                const loc = gameState.locations[key];
                const cost = COSTS.upgrades[key] * loc.level;
                content += `<button class="w-full bg-gray-600 p-2 rounded" onclick="purchaseFromMarket('${key}')">Yükselt: ${upgradables[key]} (x${loc.level+1}) - ${cost}💰</button>`;
            }
            content += '<hr class="my-3 border-slate-600">';
            if (!gameState.locations.mill.owned) { content += `<button class="w-full bg-stone-500 p-2 rounded" onclick="purchaseFromMarket('mill')">Değirmen İnşa Et (${COSTS.buildings.mill}💰)</button>`; }
            if (!gameState.locations.salesCounter2.owned) { content += `<button class="w-full bg-stone-500 p-2 rounded mt-2" onclick="purchaseFromMarket('salesCounter2')">2. Tezgahı Aç (${COSTS.buildings.marketStall}💰)</button>`; }
            openModal('Pazar Yeri', content);
        });
        document.getElementById('modal-close-btn').addEventListener('click', () => modalBackdrop.classList.add('invisible', 'opacity-0'));
    }
    function hireHelper(type) { const cost = COSTS.helpers[type]; if (gameState.player.money >= cost) { gameState.player.money -= cost; gameState.helpers.push({ id: Date.now(), type, pos: { ...gameState.locations.storageBox.pos }, state: 'idle', hasItem: false, payload: null, target: null, targetPos: null }); showMessage(`${type} yardımcısı kiralandı!`, 'success'); playSound('sale', 'A4'); } else { showMessage('Yeterli para yok!', 'error'); playSound('error', 'C3'); } }
    function purchaseFromMarket(key) {
        const loc = gameState.locations[key];
        const isUpgrade = !!COSTS.upgrades[key];
        const cost = isUpgrade ? COSTS.upgrades[key] * loc.level : COSTS.buildings[key];

        if (gameState.player.money >= cost) {
            gameState.player.money -= cost;
            if (isUpgrade) {
                loc.level++;
                showMessage(`${loc.type} seviye ${loc.level}'e yükseltildi!`, 'success');
            } else {
                loc.owned = true;
                showMessage('Yeni bina inşa edildi!', 'success');
            }
            playSound('sale', 'G4');
            modalBackdrop.classList.add('invisible', 'opacity-0');
        } else {
            showMessage('Yeterli para yok!', 'error');
            playSound('error', 'C3');
        }
    }
    let messageTimer;
    function showMessage(text, type) { clearTimeout(messageTimer); messageBox.textContent = text; messageBox.className = 'h-10 bg-black/30 rounded-lg flex items-center justify-center p-2 text-center font-semibold'; if(type === 'success') messageBox.classList.add('text-green-300'); else if(type === 'error') messageBox.classList.add('text-red-400'); else messageBox.classList.add('text-yellow-200'); }

    // --- KONTROLLER & BAŞLATMA ---
    function setupControls() {
        window.addEventListener('keydown', (e) => { const keyMap = {'ArrowUp':'up', 'w':'up', 'ArrowDown':'down', 's':'down', 'ArrowLeft':'left', 'a':'left', 'ArrowRight':'right', 'd':'right'}; if(keyMap[e.key]) keys[keyMap[e.key]].pressed = true; });
        window.addEventListener('keyup', (e) => { const keyMap = {'ArrowUp':'up', 'w':'up', 'ArrowDown':'down', 's':'down', 'ArrowLeft':'left', 'a':'left', 'ArrowRight':'right', 'd':'right'}; if(keyMap[e.key]) keys[keyMap[e.key]].pressed = false; });
        ['up', 'down', 'left', 'right'].forEach(dir => { const btn = document.getElementById(`${dir}-btn`); btn.addEventListener('mousedown', () => keys[dir].pressed = true); btn.addEventListener('mouseup', () => keys[dir].pressed = false); btn.addEventListener('mouseleave', () => keys[dir].pressed = false); btn.addEventListener('touchstart', (e) => {e.preventDefault(); keys[dir].pressed = true;}); btn.addEventListener('touchend', (e) => {e.preventDefault(); keys[dir].pressed = false;}); });
    }
    
    function gameLoop() {
        try { update(); render(); } catch (e) { console.error("Oyun Döngüsü Hatası:", e); messageBox.style.color = 'red'; messageBox.textContent = 'HATA: ' + e.message; return; }
        requestAnimationFrame(gameLoop);
    }

    function init() {
        gameState = {
            player: { pos: toPixels({ x: 10, y: 7 }), money: 1000 },
            storage: { milk: 0, egg: 0, wheat: 0, flour: 0, bread: 0, wood: 0 },
            locations: {
                salesCounter1: { type: 'salesCounter', pos: toPixels({ x: 10, y: 2 }), owned: true },
                salesCounter2: { type: 'salesCounter', pos: toPixels({ x: 16, y: 2 }), owned: false },
                storageBox: { type: 'storageBox', pos: toPixels({ x: 2, y: 2 }), owned: true },
                cow: { type: 'cow', pos: toPixels({ x: 3, y: 12 }), ready: true, cooldown: 0, owned: true, level: 1, claimedBy: null },
                chicken: { type: 'chicken', pos: toPixels({ x: 9, y: 12 }), ready: true, cooldown: 0, owned: true, level: 1, claimedBy: null },
                wheat: { type: 'wheat', pos: toPixels({ x: 15, y: 12 }), ready: true, cooldown: 0, owned: true, level: 1, claimedBy: null },
                tree: { type: 'tree', pos: toPixels({ x: 3, y: 4 }), ready: true, cooldown: 0, owned: true, level: 1, claimedBy: null },
                oven: { type: 'oven', pos: toPixels({ x: 18, y: 5 }), processing: false, timer: 0, hasProduct: false, owned: true, level: 1, claimedBy: null },
                mill: { type: 'mill', pos: toPixels({ x: 18, y: 9 }), processing: false, timer: 0, hasProduct: false, owned: false, level: 1, claimedBy: null },
            },
            helpers: [],
            millAngle: 0,
            customer1: null,
            customer2: null,
            lastInteractionTime: 0
        };

        initializeSounds();
        setupControls();
        setupModals();

        document.body.addEventListener('click', async () => {
            if (!audioStarted && typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                await Tone.start();
                audioStarted = true;
                showMessage("Sesler etkinleştirildi!", "info");
                new Tone.Loop(time => { sounds.background.triggerAttackRelease("C1", "8n", time); }, "2n").start(0);
                Tone.Transport.start();
            }
        }, { once: true });
        
        showMessage("Çiftliğe hoşgeldin!", "info");
        gameLoop();
    }
    </script>
</body>
</html>
